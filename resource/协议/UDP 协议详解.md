## UDP 协议详解



### 一、   运输层之间通信

端到端的通信是主机之间进程的通信

- 复用：发送方不同的应用进程都可以使用同一个运输层协议传输数据（需要添加合适  的报文首部）

- 分用：接收方在运输层把接受到的报文除掉报文的首部后，能够把报文准确的交给进程



### 二、UDP协议特点

* UDP 是无连接的

  > 在发送数据之前是不需要建立连接的（发送数据之后，也不需要释放连接），因此减少了开销和发送数据
  >
  > 之前的时延

* UDP 会最大努力交付数据

  > UDP 交付数据是尽自己的最大能力交付数据包，但不保证可靠交付，因此主机是不需要维护复杂的连接状态表

* UDP 是面向报文的

  > 发送方的 UDP 对应用层交下来的报文，既不合并，也不拆分，而是保留报文的边界，然后添加 UDP首
  >
  > 部，就交给IP层处理。在接收方，对于IP层交上来的报文，在去除 UDP 首部之后就交付给应用层。总的
  >
  > 来说 UDP 是一次交付一个完整的报文。

  ![UDP 流程](https://github.com/jogin666/blog/blob/master/resource/%E5%8D%8F%E8%AE%AE/images/UDP%20%E6%B5%81%E7%A8%8B.jpg)

*  UDP 没有拥塞控制

  > 对于网络出现的拥塞不会造成源主机的发送速率降低。

* UDP 支持 一对一，一对多，多对一和多对多的交付通信。

* UDP 的首部开销小，只有8个字节。

注意：UDP  也有可能造成网络拥塞问题。当多个源主机同时向网络发送高速率的实时视频时，网络就有可能发生

拥塞。



### 三、UDP的首部格式

用户数据报 UDP 有两个字段 ：数据字段和首部字段。首部字段很简单，只有8个字节，由四个字段组成，每个字段的长度都是两个字节。

* 源端口 ：发送方的端口号，在需要对方回信时选用，不需要时可用全0。
* 目的端口 ：接受方端口号，指明接收方的端口。
* 长度 ：UDP 用户数据报的长度，其最小值为8个字节（只有 UDP 首部）。
* 校验和 ： 检测 UDP 用户数据包在传输中是否有错，出错就丢弃。

![UDP的首部图](https://github.com/jogin666/blog/blob/master/resource/%E5%8D%8F%E8%AE%AE/images/UDP%E7%9A%84%E9%A6%96%E9%83%A8%E5%9B%BE.jpg)

当运输层从 IP 层收到 UDP 数据报时，会根据首部中的目的端口，把 UDP 数据报交付给应用层。

![UDP 端口分用](https://github.com/jogin666/blog/blob/master/resource/%E5%8D%8F%E8%AE%AE/images/UDP%20%E7%AB%AF%E5%8F%A3%E5%88%86%E7%94%A8.jpg)

如果接收方没有查找到 UDP 报文中指定的目的端口号不正确（即不存在对应的该端口号的应用进程），就丢弃该

报文，并有网际控制报文协议 ICMP 发送 “端口不可达”  差错报文 给发送方。

* UDP 用户数据报校验和的计算

  UDP 用于数据报校验和的计算方法有些特殊，需要在 UDP 用户数据报之前增加12个字节的伪首部，，所谓

  伪首部，是因为伪首部并不是真正的 UDP 用户数据报的首部，只是计算检验和时，临时添加在 UDP 用户数

  报之前，得到有个临时的 UDP 用户数据报，校验和就是按照这个临时的 UDP 用户数据报来计算的，伪首部

  是不会向下或者向上传输的，仅仅是用来计算检验和。在计算检验和时，UDP 是把首部和数据部分一起都检

  验的。在发送方首先是把全0放入检验和字段，再把伪首部一级 UDP 用户数据报看成是由许多的16位的字符

  串接起来的。若UDP用户数据报的数据部分不是偶数个字节，则要填入一个全零的字节（但此字节是不会发

  送）。然后按照二进制反码计算出这些16位数字的和。将此和的二进制反码写入检核字段和，仅发送 UDP 用

  户数据报。在接收方，把收到的 UDP 用户数据报添加伪首部之后，按照二进制反码计算16位字的和，然后比

  对检验和字段，当无差错时，其结果应为全1，交付给应用层，反之不为全1，那就是出错的，就丢弃用户数

  据报（或者交付给应用层，但附加有差错的警告）。下图给出了一个计算 UDP 用户数据报检验和的过程，下

  图假定了用户数据报的长度为15个字节，因此是需要添加一个全为 0 的字节。

![UDP 校验和](https://github.com/jogin666/blog/blob/master/resource/%E5%8D%8F%E8%AE%AE/images/UDP%20%E6%A0%A1%E9%AA%8C%E5%92%8C.jpg)

如图 5-5 所示，伪首部的第三个字段 全是 0；第四个字段是 IP 首部中的协议字段的值。UDP 的协议字段的值为17

第五个字段是 UDP 用户数据报的长度。因此，这样的校验和，及检查了 UDP 用户数据报的源端口和目的端口以

及 UDP 用户数据报的数据部分，有检查了 IP 数据报的源 IP 地址和目的地址。



参考资料：计算机网络（第7版） 谢希仁 编著。
