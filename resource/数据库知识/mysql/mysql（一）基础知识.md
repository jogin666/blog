## 你mysql（1）基础知识



#### 1、前言

现在市面开发用的数据库大多是 mysql 数据库，少部分用的是 oracle （因为不开源），当然也有使用自助研发的数据库，但是很少。想着自从接触 mysql 数据库后，都一直是使用的是 mysql 数据库，但还没有整体系统的学过mysql，遂而开始认真的学习一下。

#### 2、基本框架实体图

![整体示意图](https://github.com/jogin666/blog/blob/master/resource/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9F%A5%E8%AF%86/mysql/images/%E6%95%B4%E4%BD%93%E7%A4%BA%E6%84%8F%E5%9B%BE.png)

- 连接器

  当想数据库发其请求时，数据库请收到请求后，调用连接器处理该请求，是否建立连接会话。在建立连接的时候会经历 TCP 的握手过程，然后进行用户的 身份验证，权限验证，只有通过验证之后，客户端才能建立与 mysql 数据库的会话。总的来说，连接器的功能就是：① 与客户端对接，建立连接；	② 校验用户和用户权限 ；③  维持和管理客户端的连接

- 缓存

  建立连接连接之后，如果客户端发起的是查询请求，mysql 会先根据请求中的 sql 查询 mysql 数据库的缓冲 查看之前时候执行过该 sql 语句，如果缓存中存在记录，那么久从缓冲中取出结果，返回给客户端。顺便说一下：mysql 数据库是以 key-value 的形式将查询的数据存放在缓冲的，其中 key 是查询 sql，而 value 就是查询的结果 。

- 语法分析器

  如果查询请求没有命中缓存，那么 mysql 会将查询请求中的 sql 交给语法分析器，进行 词法分析，识别 sql 中的每一个字符串所代表的含义，是关键字，还是字段名等等。执行完 词法分析 之后，就会执行 语法分析，根据词法分析的结果，判断 sql 语句是否是合法的，如果不合法，就会将 sql 错误的地方返回给客户端，告诉客户端出错的地方，以及是什么错误。

- 优化器

  如果 sql 过了分析器的检验之后，接下来就会来到 优化器，优化器的的功能就是优化该 sql 查询，那怎么优化呢？很简单，是否走索引，如果走索引的话，根据 sql 判断，应该使用什么索引，比如：主键索引，联合索引等等，还有的就是对 sql 执行的顺序进行优化，查询条件那么多，是先查询那个表，还是先关联等等，优化的方案多种多样，选择哪一种就是由 优化器 所决定的。

- 执行器

  经过优化器处理后的 sql，最后有执行器执行 sql，在执行器执执时，第一步是检验权限，权限通过就去执行 sql 。在执行的时候，mysql 数据库是一行一行的判断数据时候满足条件的，如果有索引的话，执行速度就比较快，根据索引直接检索大部分的数据，然后在刷选符合条件的数据。

  mysql 数据库的慢日志有一个 *rows_examined* 字段，可以查看执行 sql 语句扫描了多少行的数据， *explain* 字段是可以查询执行计划，扫描了多少行的数据。 

#### 3、补充

- 在 mysql 使用 连接器 与客户端建立链接之后，该链接就会处于空闲状态，可以使用 mysql 提供的关键字 *show processlist* 查看空闲连接列表中处于空闲状态的连接的具体情况。

  ![show processlist](https://github.com/jogin666/blog/blob/master/resource/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9F%A5%E8%AF%86/mysql/images/show_processlist.png)

  和许多 c/s 模型一样，mysql 数据库对于长时间处于空闲状态的连接（没有响应），连接器会自主断开的。空闲时间是有 *wait_timeout* 这个参数所决定的，默认空闲连接时长是 8 小时。值得注意的是：断开后重连的时候会报错，如果想继续执行操作，那么必须要重新连接。

  对于断开重现的解决方案：mysql 还提供了长连接的解决方案，但是使用长连接之后，内存是飙升得很快，有可能造成 OOM（内存溢出，因为 mysql 数据库装载执行的过程中，临时使用的内存都是有连接对象所管理的 ，只有连接断开之后，内存才会得到释放，），导致 mysql 重启，在 jvm 里面就会导致频繁的 Full GC 。

  既然长连接不能很好的解决问题，那该怎么办？ ①：定期断开长连接，再重新连接；②：执行较大的查询之后，执行 *mysql_reset_connection* ,重新初始化连接资源。

- 对于 mysql 的缓冲

  学过 hibernate，mybatis 都应该了解到它们的缓存吧，mysql 数据库中的缓存和这个持久层框架一样，在执行对某个表更新之后，就会直接清空缓冲，所以缓冲是很容易失效的，个人感觉使用缓冲是弊大于利的。你看：在某些，积累一大堆的缓存，还没有得到使用或者得到使用的时间不多，就会被清空，也没有对缓解 mysql 数据库的压力起到多少的作用，但是也不是缓冲没有作用，在只读或者读大于写很多的情况下，缓冲还是十分好的策略。

  值得注意的是：缓冲在 mysql 8.0 版本之后就取消了。如果使用之前的版本，可以通过将 *query_cache_type* 参数设置成 *DEMAND*，这样 mysql 就不会启用缓存，想要缓存就用 *SQL_CACHE* 。如想要查询某个 sql 执行所用的真正时间，可以使用 *SQL_NO_CACHE* 关键字，比如这样： `select SQL_NO_CACHE * from table` 。



参考资料：

<a href="http://mp.weixin.qq.com/s?__biz=MzAwNDA2OTM1Ng==&mid=2453141466&idx=1&sn=c89ecc9aa3fb62dd119ad17b4a9cada5&chksm=8cf2d559bb855c4f4cf2e3377afb3270eda1e32f8a868b4df04f59372ca6603a9292ace71f5d&mpshare=1&scene=23&srcid=&sharer_sharetime=1583481710067&sharer_shareid=a8ee705dc28d6aaab271b797da5bc9c5#rd">《吊打面试官》系列-数据库基础知识</a>

